import cv2
import os
import numpy as np
from skimage.filters import gaussian
from makeup.test import evaluate

def sharpen(img):
    img = img * 1.0
    gauss_out = gaussian(img, sigma=5, multichannel=True)

    alpha = 1.5
    img_out = (img - gauss_out) * alpha + img

    img_out = img_out / 255.0

    mask_1 = img_out < 0
    mask_2 = img_out > 1

    img_out = img_out * (1 - mask_1)
    img_out = img_out * (1 - mask_2) + mask_2
    img_out = np.clip(img_out, 0, 1)
    img_out = img_out * 255
    return np.array(img_out, dtype=np.uint8)


def hair(image, parsing, part=17, color=[230, 50, 20]):
    b, g, r = color      #[10, 50, 250]       # [10, 250, 10]
    tar_color = np.zeros_like(image)
    tar_color[:, :, 0] = b
    tar_color[:, :, 1] = g
    tar_color[:, :, 2] = r

    bright = color[0]

    image_hsv = cv2.cvtColor(image, cv2.COLOR_BGR2HSV)
    tar_hsv = cv2.cvtColor(tar_color, cv2.COLOR_BGR2HSV)
    
    if part == 1 or part == 10:
        if bright > 0:
            image_hsv[:, :, 2] += bright
        else:
            bright *= -1
            image_hsv[:, :, 2] -= bright
    elif part == 12 or part == 13:
        image_hsv[:, :, 0:1] = tar_hsv[:, :, 0:1]
    else:
        image_hsv[:, :, 0:1] = tar_hsv[:, :, 0:1]

    changed = cv2.cvtColor(image_hsv, cv2.COLOR_HSV2BGR)

    if part == 17:
        changed = sharpen(changed)

    changed[parsing != part] = image[parsing != part]
    return changed


def makeup(celebName, celebPosition):
    table = {
        #'hair': 17,
        'face': 1,
        'left_eye': 2,
        'right_eye': 3,
        'nose': 10,
        'upper_lip': 12,
        'lower_lip': 13
    }

    image_path = 'input/androidFlask.jpg'
    cp = 'makeup/cp/79999_iter.pth'

    image = cv2.imread(image_path)
    height, width, _ = image.shape
    
    image = cv2.resize(image, (1024, 1024))
    ori = image.copy()
    parsing = evaluate(image_path, cp)
    parsing = cv2.resize(parsing, image.shape[0:2], interpolation=cv2.INTER_NEAREST)

    parts = [table['face'], table['left_eye'], table['right_eye'], table['nose'], table['upper_lip'], table['lower_lip']]

    color_dict = {'chaeyeong0': [[15, 0, 0], [0, 0, 0], [0, 0, 0], [15, 0, 0], [60, 60, 255], [60, 60, 255]],
                  'chaeyeong1': [[5, 0, 0], [0, 0, 0], [0, 0, 0], [5, 0, 0], [128, 128, 255], [128, 128, 255]],
                  'chaeyeong2': [[15, 0, 0], [0, 0, 0], [0, 0, 0], [15, 0, 0], [30, 60, 255], [30, 60, 255]],
                  'chaeyeong3': [[1, 0, 0], [0, 0, 0], [0, 0, 0], [1, 0, 0], [196, 196, 255], [196, 196, 255]],
                  'chaeyeong4': [[-10, 0, 0], [0, 0, 0], [0, 0, 0], [-10, 0, 0], [128, 128, 255], [128, 128, 255]],
                  'dahyeon0': [[15, 0, 0], [128, 188, 255], [128, 188, 255], [15, 0, 0], [196, 196, 255], [196, 196, 255]],
                  'dahyeon1': [[15, 0, 0], [128, 188, 255], [128, 188, 255], [15, 0, 0], [196, 196, 255], [196, 196, 255]],
                  'dahyeon2': [[15, 0, 0], [128, 188, 255], [128, 188, 255], [15, 0, 0], [0, 0, 255], [0, 0, 255]],
                  'dahyeon3': [[15, 0, 0], [128, 188, 255], [128, 188, 255], [15, 0, 0], [196, 196, 255], [196, 196, 255]],
                  'dahyeon4': [[10, 0, 0], [128, 188, 255], [128, 188, 255], [10, 0, 0], [196, 196, 255], [196, 196, 255]],
                  'jeongyeon0': [[15, 0, 0], [128, 188, 255], [128, 188, 255], [15, 0, 0], [128, 0, 255], [128, 0, 255]],
                  'jeongyeon1': [[5, 0, 0], [128, 188, 255], [128, 188, 255], [5, 0, 0], [30, 30, 255], [30, 30, 255]],
                  'jeongyeon2': [[15, 0, 0], [128, 188, 255], [128, 188, 255], [15, 0, 0], [0, 0, 255], [0, 0, 255]],
                  'jeongyeon3': [[15, 0, 0], [128, 188, 255], [128, 188, 255], [15, 0, 0], [216, 196, 255], [216, 196, 255]],
                  'jeongyeon4': [[15, 0, 0], [128, 188, 255], [128, 188, 255], [15, 0, 0], [128, 0, 255], [128, 0, 255]],
                  'jihyo0': [[10, 0, 0], [0, 0, 0], [0, 0, 0], [10, 0, 0], [128, 128, 255], [128, 128, 255]],
                  'jihyo1': [[15, 0, 0], [0, 0, 0], [0, 0, 0], [15, 0, 0], [128, 0, 255], [128, 0, 255]],
                  'jihyo2': [[10, 0, 0], [0, 0, 0], [0, 0, 0], [10, 0, 0], [196, 196, 255], [196, 196, 255]],
                  'jihyo3': [[5, 0, 0], [0, 0, 0], [0, 0, 0], [5, 0, 0], [128, 0, 255], [128, 0, 255]],
                  'jihyo4': [[15, 0, 0], [0, 0, 0], [0, 0, 0], [15, 0, 0], [96, 128, 255], [96, 128, 255]],
                  'mina0': [[15, 0, 0], [0, 0, 0], [0, 0, 0], [15, 0, 0], [30, 60, 255], [30, 60, 255]],
                  'mina1': [[10, 0, 0], [0, 0, 0], [0, 0, 0], [10, 0, 0], [196, 196, 255], [196, 196, 255]],
                  'mina2': [[5, 0, 0], [0, 0, 0], [0, 0, 0], [5, 0, 0], [216, 196, 255], [216, 196, 255]],
                  'mina3': [[15, 0, 0], [0, 0, 0], [0, 0, 0], [15, 0, 0], [216, 216, 255], [216, 216, 255]],
                  'mina4': [[-3, 0, 0], [0, 0, 0], [0, 0, 0], [-3, 0, 0], [0, 0, 255], [0, 0, 255]],
                  'momo0': [[15, 0, 0], [0, 0, 0], [0, 0, 0], [15, 0, 0], [128, 0, 255], [128, 0, 255]],
                  'momo1': [[15, 0, 0], [0, 0, 0], [0, 0, 0], [15, 0, 0], [128, 0, 255], [128, 0, 255]],
                  'momo2': [[15, 0, 0], [0, 0, 0], [0, 0, 0], [15, 0, 0], [216, 196, 255], [216, 196, 255]],
                  'momo3': [[-3, 0, 0], [0, 0, 0], [0, 0, 0], [-3, 0, 0], [128, 0, 255], [128, 0, 255]],
                  'momo4': [[15, 0, 0], [0, 0, 0], [0, 0, 0], [15, 0, 0], [0, 0, 255], [0, 0, 255]],
                  'nayeon0': [[5, 0, 0], [0, 0, 0], [0, 0, 0], [5, 0, 0], [0, 0, 255], [0, 0, 255]],
                  'nayeon1': [[15, 0, 0], [0, 0, 0], [0, 0, 0], [15, 0, 0], [128, 128, 255], [128, 128, 255]],
                  'nayeon2': [[5, 0, 0], [0, 0, 0], [0, 0, 0], [5, 0, 0], [128, 128, 255], [128, 128, 255]],
                  'nayeon3': [[15, 0, 0], [0, 0, 0], [0, 0, 0], [15, 0, 0], [0, 0, 255], [0, 0, 255]],
                  'nayeon4': [[3, 0, 0], [0, 0, 0], [0, 0, 0], [3, 0, 0], [40, 40, 255], [40, 40, 255]],
                  'sana0': [[5, 0, 0], [128, 188, 255], [128, 188, 255], [5, 0, 0], [0, 0, 255], [0, 0, 255]],
                  'sana1': [[15, 0, 0], [128, 188, 255], [128, 188, 255], [15, 0, 0], [196, 196, 255], [196, 196, 255]],
                  'sana2': [[10, 0, 0], [128, 188, 255], [128, 188, 255], [10, 0, 0], [30, 60, 255], [30, 60, 255]],
                  'sana3': [[15, 0, 0], [128, 188, 255], [128, 188, 255], [0, 0, 255], [0, 0, 255]],
                  'sana4': [[15, 0, 0], [0, 0, 0], [0, 0, 0], [15, 0, 0], [0, 0, 255], [0, 0, 255]],
                  'tzuyu0': [[5, 0, 0], [128, 188, 255], [128, 188, 255], [5, 0, 0], [196, 196, 255], [196, 196, 255]],
                  'tzuyu1': [[15, 0, 0], [0, 0, 0], [0, 0, 0], [15, 0, 0], [32, 32, 255], [32, 32, 255]],
                  'tzuyu2': [[5, 0, 0], [128, 188, 255], [128, 188, 255], [5, 0, 0], [32, 32, 255], [32, 32, 255]],
                  'tzuyu3': [[5, 0, 0], [128, 188, 255], [128, 188, 255], [5, 0, 0], [128, 128, 255], [128, 128, 255]],
                  'tzuyu4': [[3, 0, 0], [0, 0, 0], [0, 0, 0], [3, 0, 0], [0, 0, 128], [0, 0, 128]]}
    colors = color_dict[celebName + celebPosition]

    for part, color in zip(parts, colors):
        image = hair(image, parsing, part, color)

    cv2.imwrite('output/output.jpg', cv2.resize(image, (width, height)))










